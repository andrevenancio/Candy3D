/*
 Candy3D lightweight javascript 3D Engine running on webgl.
 author: info@andrevenancio.com (Andre Venancio).
*/
var CANDY3D=CANDY3D||{name:"Candy3D",version:"0.0.1",settings:{preserveDrawingBuffer:!1,premultipliedAlpha:!0,antialias:!0,stencil:!0,alpha:!0}};CANDY3D.inherits=function(a,b){var c=function(){};c.prototype=b.prototype;a.superClass=b.prototype;a.prototype=new c;a.prototype.constructor=a};CANDY3D.generateGuid=function(a){for(var a=a||"",b=0;15>b;b++){if(5===b||10===b)a+="-";var c=Math.floor(16*Math.random()).toString(16).toUpperCase(),a=a+c}return a};CANDY3D.Matrix4=function(a,b,c,d,f,g,e,j,i,k,h,m,n,l,o,p){this.m=new Float32Array(16);this.m[0]=a||1;this.m[1]=b||0;this.m[2]=c||0;this.m[3]=d||0;this.m[4]=f||0;this.m[5]=g||1;this.m[6]=e||0;this.m[7]=j||0;this.m[8]=i||0;this.m[9]=k||0;this.m[10]=h||1;this.m[11]=m||0;this.m[12]=n||0;this.m[13]=l||0;this.m[14]=o||0;this.m[15]=p||1};CANDY3D.Matrix4.translate=function(a,b,c){var d=new CANDY3D.Matrix4;d.m[12]=a;d.m[13]=b;d.m[14]=c;return d};
CANDY3D.Matrix4.scale=function(a,b,c){var d=new CANDY3D.Matrix4;d.m[0]=a;d.m[5]=b;d.m[10]=c;return d};CANDY3D.Matrix4.rotateX=function(a){var b=Math.cos(a),a=Math.sin(a),c=new CANDY3D.Matrix4;c.m[5]=b;c.m[6]=a;c.m[9]=-a;c.m[10]=b;return c};CANDY3D.Matrix4.rotateY=function(a){var b=Math.cos(a),a=Math.sin(a),c=new CANDY3D.Matrix4;c.m[0]=b;c.m[2]=-a;c.m[8]=a;c.m[10]=b;return c};
CANDY3D.Matrix4.rotateZ=function(a){var b=Math.cos(a),a=Math.sin(a),c=new CANDY3D.Matrix4;c.m[0]=b;c.m[1]=a;c.m[4]=-a;c.m[5]=b;return c};
CANDY3D.Matrix4.multiply=function(a,b){var c=a.m[0],d=a.m[1],f=a.m[2],g=a.m[3],e=a.m[4],j=a.m[5],i=a.m[6],k=a.m[7],h=a.m[8],m=a.m[9],n=a.m[10],l=a.m[11],o=a.m[12],p=a.m[13],q=a.m[14],r=a.m[15],s=b.m[0],t=b.m[1],u=b.m[2],v=b.m[3],w=b.m[4],x=b.m[5],y=b.m[6],z=b.m[7],A=b.m[8],B=b.m[9],C=b.m[10],D=b.m[11],E=b.m[12],F=b.m[13],G=b.m[14],H=b.m[15];return{m:[c*s+d*w+f*A+g*E,c*t+d*x+f*B+g*F,c*u+d*y+f*C+g*G,c*v+d*z+f*D+g*H,e*s+j*w+i*A+k*E,e*t+j*x+i*B+k*F,e*u+j*y+i*C+k*G,e*v+j*z+i*D+k*H,h*s+m*w+n*A+l*E,h*t+
m*x+n*B+l*F,h*u+m*y+n*C+l*G,h*v+m*z+n*D+l*H,o*s+p*w+q*A+r*E,o*t+p*x+q*B+r*F,o*u+p*y+q*C+r*G,o*v+p*z+q*D+r*H]}};CANDY3D.Matrix4.makePerspective=function(a,b,c,d){var a=Math.tan(0.5*Math.PI-0.5*(a*Math.PI/180)),f=1/(c-d),g=new CANDY3D.Matrix4;g.m[0]=a/b;g.m[5]=a;g.m[10]=(c+d)*f;g.m[11]=-1;g.m[14]=2*c*d*f;g.m[15]=0;return g};
CANDY3D.Matrix4.lookAt=function(a,b,c){var b=CANDY3D.Vector3.normalize(CANDY3D.Vector3.subtract(a,b)),c=CANDY3D.Vector3.Cross(c,b),d=CANDY3D.Vector3.Cross(b,c),f=new CANDY3D.Matrix4;f.m[0]=c.x;f.m[1]=c.y;f.m[2]=c.z;f.m[3]=0;f.m[4]=d.x;f.m[5]=d.y;f.m[6]=d.z;f.m[7]=0;f.m[8]=b.x;f.m[9]=b.y;f.m[10]=b.z;f.m[11]=0;f.m[12]=a.x;f.m[13]=a.y;f.m[14]=a.z;f.m[15]=1;return f};
CANDY3D.Matrix4.Invert=function(a){var b=a.m[0],c=a.m[1],d=a.m[2],f=a.m[3],g=a.m[4],e=a.m[5],j=a.m[6],i=a.m[7],k=a.m[8],h=a.m[9],m=a.m[10],n=a.m[11],l=a.m[12],o=a.m[13],p=a.m[14],a=a.m[15],q=m*a,r=p*n,s=j*a,t=p*i,u=j*n,v=m*i,w=d*a,x=p*f,y=d*n,z=m*f,A=d*i,B=j*f,C=k*o,D=l*h,E=g*o,F=l*e,G=g*h,H=k*e,I=b*o,J=l*c,K=b*h,L=k*c,M=b*e,N=g*c,O=q*e+t*h+u*o-(r*e+s*h+v*o),P=r*c+w*h+z*o-(q*c+x*h+y*o),o=s*c+x*e+A*o-(t*c+w*e+B*o),c=v*c+y*e+B*h-(u*c+z*e+A*h),e=1/(b*O+g*P+k*o+l*c),h=new CANDY3D.Matrix4;h.m[0]=e*O;h.m[1]=
e*P;h.m[2]=e*o;h.m[3]=e*c;h.m[4]=e*(r*g+s*k+v*l-(q*g+t*k+u*l));h.m[5]=e*(q*b+x*k+y*l-(r*b+w*k+z*l));h.m[6]=e*(t*b+w*g+B*l-(s*b+x*g+A*l));h.m[7]=e*(u*b+z*g+A*k-(v*b+y*g+B*k));h.m[8]=e*(C*i+F*n+G*a-(D*i+E*n+H*a));h.m[9]=e*(D*f+I*n+L*a-(C*f+J*n+K*a));h.m[10]=e*(E*f+J*i+M*a-(F*f+I*i+N*a));h.m[11]=e*(H*f+K*i+N*n-(G*f+L*i+M*n));h.m[12]=e*(E*m+H*p+D*j-(G*p+C*j+F*m));h.m[13]=e*(K*p+C*d+J*m-(I*m+L*p+D*d));h.m[14]=e*(I*j+N*p+F*d-(M*p+E*d+J*j));h.m[15]=e*(M*m+G*d+L*j-(K*j+N*m+H*d));return h};CANDY3D.Vector3=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};CANDY3D.Vector3.subtract=function(a,b){return new CANDY3D.Vector3(a.x-b.x,a.y-b.y,a.z-b.z)};CANDY3D.Vector3.normalize=function(a){var b=CANDY3D.Vector3.len(a);return 1E-5<b?new CANDY3D.Vector3(a.x/b,a.y/b,a.z/b):new CANDY3D.Vector3(0,0,0)};CANDY3D.Vector3.len=function(a){return Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z)};CANDY3D.Vector3.Dot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z};
CANDY3D.Vector3.Cross=function(a,b){return new CANDY3D.Vector3(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x)};CANDY3D.Object3D=function(){this.position=new CANDY3D.Vector3(0,0,0);this.rotation=new CANDY3D.Vector3(0,0,0);this.scale=new CANDY3D.Vector3(1,1,1)};CANDY3D.Face=function(a){this.vertices=a};CANDY3D.Mesh=function(){CANDY3D.Object3D.call(this);this.uid=CANDY3D.generateGuid();this.geometry={vertices:[],faces:[],vbuffer:null,sbuffer:null,program:null,uniforms:null}};CANDY3D.inherits(CANDY3D.Mesh,CANDY3D.Object3D);CANDY3D.Plane=function(a,b,c,d){CANDY3D.Mesh.call(this);this.widthSegments=c||1;this.heightSegments=d||1;this.build(a||200,b||200)};CANDY3D.inherits(CANDY3D.Plane,CANDY3D.Mesh);CANDY3D.Plane.prototype.toString=function(){return"Candy3D.Plane"};
CANDY3D.Plane.prototype.build=function(a,b){var c,d,f=a/2,g=b/2,e=this.widthSegments,j=this.heightSegments,i=e+1,k=j+1,h=a/e,m=b/j;for(d=0;d<k;d++)for(c=0;c<i;c++)this.geometry.vertices.push(new CANDY3D.Vector3(c*h-f,-(d*m-g),0));for(d=0;d<j;d++)for(c=0;c<e;c++)f=c+i*(d+1),g=c+1+i*(d+1),k=c+1+i*d,this.geometry.faces.push(new CANDY3D.Face([c+i*d,k,f])),this.geometry.faces.push(new CANDY3D.Face([f,k,g]));this.geometry.vbuffer=new Float32Array(9*this.geometry.faces.length);this.geometry.sbuffer=new Float32Array(9*
this.geometry.vertices.length)};CANDY3D.Sphere=function(a,b,c,d,f,g,e){CANDY3D.Mesh.call(this);this.radius=a||50;this.widthSegments=Math.max(3,Math.floor(b)||8);this.heightSegments=Math.max(2,Math.floor(c)||6);this.phiStart=void 0!==d?d:0;this.phiLength=void 0!==f?f:2*Math.PI;this.thetaStart=void 0!==g?g:0;this.thetaLength=void 0!==e?e:Math.PI};CANDY3D.inherits(CANDY3D.Sphere,CANDY3D.Mesh);CANDY3D.Sphere.prototype.toString=function(){return"Candy3D.Sphere"};
CANDY3D.Sphere.prototype.build=function(a,b,c,d,f,g,e){var j,i,k=[];for(i=0;i<=c;i++){var h=[];for(j=0;j<=b;j++){var m=j/b,n=i/c,l=new CANDY3D.Vector3;l.x=-a*Math.cos(d+m*f)*Math.sin(g+n*e);l.y=a*Math.cos(g+n*e);l.z=a*Math.sin(d+m*f)*Math.sin(g+n*e);this.geometry.vertices.push(l);h.push(this.geometry.vertices.length-1)}k.push(h)}for(i=0;i<this.heightSegments;i++)for(j=0;j<this.widthSegments;j++)a=k[i][j+1],b=k[i][j],c=k[i+1][j],d=k[i+1][j+1],Math.abs(this.geometry.vertices[a].y)===this.radius?this.geometry.faces.push(new CANDY3D.Face([a,
c,d])):Math.abs(this.geometry.vertices[c].y)===this.radius?this.geometry.faces.push(new CANDY3D.Face([a,b,c])):(this.geometry.faces.push(new CANDY3D.Face([a,b,d])),this.geometry.faces.push(new CANDY3D.Face([b,c,d])));this.geometry.vbuffer=new Float32Array(9*this.geometry.faces.length);this.geometry.sbuffer=new Float32Array(9*this.geometry.vertices.length)};CANDY3D.Shaders={gl:null,createProgram:function(a,b,c){this.gl=a;a=this.createShader(b,this.gl.VERTEX_SHADER);c=this.createShader(c,this.gl.FRAGMENT_SHADER);b=this.gl.createProgram();this.gl.attachShader(b,a);this.gl.attachShader(b,c);this.gl.linkProgram(b);return b},createShader:function(a,b){var c=this.gl.createShader(b);this.gl.shaderSource(c,a);this.gl.compileShader(c);if(!this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS)){var d=this.gl.getShaderInfoLog(c);console.error("Error compiling shader",
c,d);this.gl.deleteShader(c);return null}return c}};CANDY3D.Shaders.VERTEX="attribute vec4 a_position;attribute vec4 a_color;uniform mat4 u_matrix;varying vec4 v_color;void main() {   gl_Position = u_matrix * a_position;  v_color = a_color;}";CANDY3D.Shaders.FRAGMENT="precision mediump float;varying vec4 v_color;void main() {  gl_FragColor = v_color;}";CANDY3D.WebGLRenderer=function(a){this.canvas=this.domElement=document.createElement("canvas");this.fullscreen=a||!0;this.width=320;this.height=240;this.init()};
CANDY3D.WebGLRenderer.prototype.init=function(){this.gl=this.canvas.getContext("experimental-webgl",{preserveDrawingBuffer:CANDY3D.settings.preserveDrawingBuffer,premultipliedAlpha:CANDY3D.settings.premultipliedAlpha,antialias:CANDY3D.settings.antialias,stencil:CANDY3D.settings.stencil,alpha:CANDY3D.settings.alpha});this.gl.enable(this.gl.CULL_FACE);this.gl.cullFace(this.gl.BACK);this.gl.frontFace(this.gl.CW);this.gl.enable(this.gl.DEPTH_TEST);this.resize();console.log(CANDY3D.name,CANDY3D.version)};
CANDY3D.WebGLRenderer.prototype.resize=function(a,b){this.width=a||!0===this.fullscreen?window.innerWidth:320;this.height=b||!0===this.fullscreen?window.innerHeight:240;this.canvas.width=this.width;this.canvas.height=this.height;this.gl.viewportWidth=this.width;this.gl.viewportHeight=this.height;this.gl.viewport(0,0,this.width,this.height)};CANDY3D.WebGLRenderer.prototype.clear=function(){this.gl.clearColor(0,0,0,1);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)};
CANDY3D.WebGLRenderer.prototype.render=function(a,b){this.scene=a;this.camera=b;this.clear();for(var c=CANDY3D.Matrix4.makePerspective(this.camera.fov,this.width/this.height,this.camera.near,this.camera.far),d=CANDY3D.Matrix4.translate(this.camera.position.x,this.camera.position.y,this.camera.position.z),d=CANDY3D.Matrix4.multiply(d,CANDY3D.Matrix4.rotateX(this.camera.rotation.x)),d=CANDY3D.Matrix4.multiply(d,CANDY3D.Matrix4.rotateY(this.camera.rotation.y)),d=CANDY3D.Matrix4.multiply(d,CANDY3D.Matrix4.rotateZ(this.camera.rotation.z)),
d=CANDY3D.Matrix4.lookAt(new CANDY3D.Vector3(d.m[12],d.m[13],d.m[14]),this.camera.eye,this.camera.up),d=CANDY3D.Matrix4.Invert(d),f=0;f<this.scene.children.length;f++){var g=this.scene.children[f],e=CANDY3D.Matrix4.translate(g.position.x,g.position.y,g.position.z),j=CANDY3D.Matrix4.rotateX(g.rotation.x),i=CANDY3D.Matrix4.rotateY(g.rotation.y),k=CANDY3D.Matrix4.rotateZ(g.rotation.z),h=CANDY3D.Matrix4.scale(g.scale.x,g.scale.y,g.scale.z),e=CANDY3D.Matrix4.multiply(h,e),e=CANDY3D.Matrix4.multiply(e,
k),e=CANDY3D.Matrix4.multiply(e,i),e=CANDY3D.Matrix4.multiply(e,j),e=CANDY3D.Matrix4.multiply(e,d),e=CANDY3D.Matrix4.multiply(e,c);this.buildProgram(g);this.gl.useProgram(g.geometry.program);this.gl.uniformMatrix4fv(g.geometry.uniforms,!1,e.m);this.gl.drawArrays(this.gl.TRIANGLES,0,g.geometry.vbuffer.length/3)}};
CANDY3D.WebGLRenderer.prototype.buildProgram=function(a){null===a.geometry.program&&(a.geometry.program=CANDY3D.Shaders.createProgram(this.gl,CANDY3D.Shaders.VERTEX,CANDY3D.Shaders.FRAGMENT));null===a.geometry.uniforms&&(a.geometry.uniforms=this.gl.getUniformLocation(a.geometry.program,"u_matrix"));for(var b=0,c=0;c<a.geometry.faces.length;c++)for(var d=0;d<a.geometry.faces[c].vertices.length;d++){var f=a.geometry.faces[c].vertices[d];a.geometry.vbuffer[3*b]=a.geometry.vertices[f].x;a.geometry.vbuffer[3*
b+1]=a.geometry.vertices[f].y;a.geometry.vbuffer[3*b+2]=a.geometry.vertices[f].z;b++}a.geometry.sbuffer=new Float32Array(a.geometry.vbuffer.length);for(b=0;b<a.geometry.sbuffer.length;b+=3)a.geometry.sbuffer[b+0]=255*Math.random(),a.geometry.sbuffer[b+1]=255*Math.random(),a.geometry.sbuffer[b+2]=255*Math.random();c=this.gl.getAttribLocation(a.geometry.program,"a_position");b=this.gl.getAttribLocation(a.geometry.program,"a_color");d=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,d);
this.gl.enableVertexAttribArray(c);this.gl.vertexAttribPointer(c,3,this.gl.FLOAT,!1,0,0);this.gl.bufferData(this.gl.ARRAY_BUFFER,a.geometry.vbuffer,this.gl.STATIC_DRAW);c=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,c);this.gl.enableVertexAttribArray(b);this.gl.vertexAttribPointer(b,3,this.gl.UNSIGNED_BYTE,!0,0,0);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Uint8Array(a.geometry.sbuffer),this.gl.STATIC_DRAW)};CANDY3D.Scene=function(){this.children=[]};
CANDY3D.Scene.prototype.add=function(a){if(window.gui){var b=window.gui.addFolder(a.toString()+" ["+a.uid+"]");b.add(a,"uid").name("guid");var c=b.addFolder("scale");c.add(a.scale,"x",-1,1);c.add(a.scale,"y",-1,1);c.add(a.scale,"z",-1,1);c=b.addFolder("position");c.add(a.position,"x",-500,500);c.add(a.position,"y",-500,500);c.add(a.position,"z",-500,500);b=b.addFolder("rotation");b.add(a.rotation,"x",-360*Math.PI/180,360*Math.PI/180);b.add(a.rotation,"y",-360*Math.PI/180,360*Math.PI/180);b.add(a.rotation,
"z",-360*Math.PI/180,360*Math.PI/180)}this.children.push(a)};CANDY3D.Scene.prototype.remove=function(a){for(var b=0;b<this.children.length;b++)if(this.children[b].uid===a){window.gui&&window.gui.removeFolder(this.children[b].toString()+" ["+this.children[b].uid+"]");this.children.splice(b,1);break}};CANDY3D.PerspectiveCamera=function(a,b,c){CANDY3D.Object3D.call(this);this.up=new CANDY3D.Vector3(0,1,0);this.down=new CANDY3D.Vector3(0,-1,0);this.fov=a||60;this.near=b||1;this.far=c||2E3;this.position=new CANDY3D.Vector3(0,0,500);this.eye=new CANDY3D.Vector3};CANDY3D.inherits(CANDY3D.PerspectiveCamera,CANDY3D.Object3D);
